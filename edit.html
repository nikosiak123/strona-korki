<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zarządzaj rezerwacją - Zakręcone Korepetycje</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .edit-container { display: flex; gap: 2rem; max-width: 1200px; margin: 2.5rem auto; }
        .details-panel, .calendar-panel { background-color: var(--container-bg-color); border-radius: 16px; box-shadow: 0 8px 24px var(--shadow-color); padding: 2.5rem; }
        .details-panel { flex: 1; }
        .calendar-panel { flex: 2; }
        .details-panel h2 { margin-top: 0; }
        .details-item { margin-bottom: 1rem; font-size: 1.1rem; }
        .details-item strong { color: var(--text-dark); }
        .details-item span { color: var(--text-medium); }
        .action-buttons { margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; }
        .btn-danger { background-color: #DC3545; color: white; }
        .btn-danger:hover { background-color: #C82333; }
        .btn:disabled { background-color: #E0E0E0; color: var(--text-light); cursor: not-allowed; }
        .time-limit-info { margin-top: 1rem; font-size: 0.9rem; color: var(--text-light); }
    </style>
</head>
<body>
    <header><h1>Zarządzaj rezerwacją</h1></header>

    <!-- Przycisk pomocy -->
    <button class="help-button" onclick="openHelpModal()">Pomoc</button>

    <main id="loadingState" class="container" style="text-align: center; padding: 4rem;">
        <h2>Ładowanie danych rezerwacji...</h2>
    </main>

    <main id="editState" class="edit-container" style="display: none;">
        <aside class="details-panel">
            <h2>Twoja rezerwacja</h2>
            <div id="reservationDetails"></div>
            <div class="action-buttons">
                <button id="rescheduleButton" class="btn" disabled>Zmień termin</button>
                <button id="cancelButton" class="btn btn-danger" disabled>Odwołaj lekcję</button>
            </div>
            <p id="timeLimitInfo" class="time-limit-info"></p>
            <p id="refundInfo" class="time-limit-info" style="color: #4CAF50; font-weight: 600;"></p>
        </aside>

        <section class="calendar-panel">
            <h2>Wybierz nowy termin</h2>
            <p>Dostępne terminy dla korepetytora: <strong id="tutorNameInfo"></strong></p>
            <p>Aktualnie wybrany: <strong id="newSelectionInfo">Brak</strong></p>
            <div id="calendar-container">
                <p>Ładowanie dostępnych terminów...</p>
            </div>
            <!-- DODANO: Kontener dla widoku mobilnego -->
            <div id="calendar-mobile-container"></div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingState = document.getElementById('loadingState');
            const editState = document.getElementById('editState');
            const detailsElement = document.getElementById('reservationDetails');
            const timeLimitInfo = document.getElementById('timeLimitInfo');
            const cancelButton = document.getElementById('cancelButton');
            const rescheduleButton = document.getElementById('rescheduleButton');
            const newSelectionInfo = document.getElementById('newSelectionInfo');
            const calendarContainer = document.getElementById('calendar-container');
            const mobileCalendarContainer = document.getElementById('calendar-mobile-container');
            const tutorNameInfo = document.getElementById('tutorNameInfo');
            
            let originalTutor = null;
            let clientID = null;

            const API_BASE_URL = 'https://zakręcone-korepetycje.pl';

            const monthNames = ["Sty", "Lut", "Mar", "Kwi", "Maj", "Cze", "Lip", "Sie", "Wrz", "Paź", "Lis", "Gru"];
            const dayNamesFull = ["Niedziela", "Poniedziałek", "Wtorek", "Środa", "Czwartek", "Piątek", "Sobota"];
            const workingHoursStart = 8, workingHoursEnd = 22;

            let availableSlotsData = {};
            let currentWeekStart = getMonday(new Date());
            let newSelectedDate = null;
            let newSelectedTime = null;
            let newSelectedSlotId = null;

            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');

            if (!token) {
                loadingState.innerHTML = '<h2>Błąd: Brak identyfikatora rezerwacji w linku.</h2>';
                return;
            }

            try {
                const details = await fetchReservationDetails(token);
                displayReservationDetails(details);
                loadingState.style.display = 'none';
                editState.style.display = 'flex';
                await fetchAvailableSlots(currentWeekStart);
            } catch (error) {
                console.error("Błąd w głównej logice:", error);
                loadingState.innerHTML = `<h2>Wystąpił błąd: ${error.message}</h2>`;
            }

            cancelButton.addEventListener('click', async () => {
                if (confirm("Czy na pewno chcesz odwołać tę lekcję? Tej operacji nie można cofnąć.")) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/cancel-reservation`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: token })
                        });
                        if (!response.ok) throw new Error((await response.json()).message || "Nie udało się odwołać lekcji.");
                        alert("Lekcja została odwołana.");
                        window.location.href = clientID ? `/moje-lekcje?clientID=${clientID}` : '/';
                    } catch (error) {
                        alert(`Błąd: ${error.message}`);
                    }
                }
            });
            
            rescheduleButton.addEventListener('click', async () => {
                if (!newSelectedDate || !newSelectedTime) {
                    alert("Proszę wybrać nowy termin z kalendarza.");
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE_URL}/api/reschedule-reservation`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: token, newDate: newSelectedDate, newTime: newSelectedTime })
                    });
                    if (!response.ok) throw new Error((await response.json()).message || "Nie udało się zmienić terminu.");
                    
                    alert((await response.json()).message);
                    window.location.href = clientID ? `/moje-lekcje?clientID=${clientID}` : window.location.reload();
                } catch (error) {
                    alert(`Błąd: ${error.message}`);
                }
            });

            async function fetchReservationDetails(token) {
                const url = `${API_BASE_URL}/api/get-reservation-details?token=${token}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Nie można załadować danych rezerwacji.`);
                const details = await response.json();
                originalTutor = details.tutor;
                clientID = details.clientID;
                return details;
            }

            function displayReservationDetails(details) {
                tutorNameInfo.textContent = details.tutor;
                detailsElement.innerHTML = `
                    <div class="details-item"><strong>Uczeń:</strong> <span>${details.student}</span></div>
                    <div class="details-item"><strong>Korepetytor:</strong> <span>${details.tutor}</span></div>
                    <div class="details-item"><strong>Termin:</strong> <span>${details.date} o ${details.time}</span></div>
                `;
                const hoursLimit = details.isTestLesson ? 6 : 12;
                if (details.isCancellationAllowed) {
                    cancelButton.disabled = false;
                    timeLimitInfo.textContent = `Możesz odwołać lub zmienić termin do ${hoursLimit} godzin przed rozpoczęciem zajęć.`;
                    refundInfo.textContent = "Odwołanie lekcji w tym terminie spowoduje zwrot środków na Twoje konto.";
                } else {
                    timeLimitInfo.textContent = `Pozostało mniej niż ${hoursLimit} godziny do rozpoczęcia zajęć. Nie można już zarządzać tym terminem.`;
                    refundInfo.textContent = "Odwołanie lekcji w tym terminie nie spowoduje zwrotu środków.";
                }
            }

            function selectSlot(slotId, element, date, time) {
                document.querySelectorAll('.time-block.selected').forEach(el => el.classList.remove('selected'));
                document.querySelectorAll(`[data-slot-id="${slotId}"]`).forEach(el => el.classList.add('selected'));
                
                newSelectedSlotId = slotId;
                newSelectedDate = date;
                newSelectedTime = time;
                
                newSelectionInfo.textContent = `${date} o ${time}`;
                if (!cancelButton.disabled) {
                    rescheduleButton.disabled = false;
                }
            }
            
            function getMonday(d) {
                d = new Date(d);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            }
            function getFormattedDate(date) {
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            }

            async function fetchAvailableSlots(startDate) {
                if (!originalTutor) {
                    calendarContainer.innerHTML = `<p style="color: red;">Błąd: Brak informacji o korepetytorze.</p>`;
                    mobileCalendarContainer.innerHTML = calendarContainer.innerHTML;
                    return;
                }
                const loadingHTML = '<p>Ładowanie dostępnych terminów...</p>';
                calendarContainer.innerHTML = loadingHTML;
                mobileCalendarContainer.innerHTML = loadingHTML;

                try {
                    const params = new URLSearchParams({ startDate: getFormattedDate(startDate), tutorName: originalTutor });
                    const response = await fetch(`${API_BASE_URL}/api/get-schedule?${params.toString()}`);
                    if (!response.ok) throw new Error('Błąd pobierania grafiku z serwera.');
                    
                    const scheduleFromApi = await response.json();
                    
                    const processedData = {};
                    scheduleFromApi.forEach(slot => {
                        if (slot.status === 'available') {
                           if (!processedData[slot.date]) processedData[slot.date] = [];
                           processedData[slot.date].push(slot);
                        }
                    });
                    availableSlotsData = processedData;
                    renderCalendarViews(startDate);
                } catch (error) {
                    calendarContainer.innerHTML = `<p style="color: red;">${error.message}</p>`;
                    mobileCalendarContainer.innerHTML = calendarContainer.innerHTML;
                }
            }

            function renderCalendarViews(startDate) {
                calendarContainer.innerHTML = '';
                mobileCalendarContainer.innerHTML = '';

                generatePCGridCalendar(startDate);
                generateMobileListCalendar(startDate);

                calendarContainer.querySelector('#prevWeek')?.addEventListener('click', () => changeWeek(-7));
                calendarContainer.querySelector('#nextWeek')?.addEventListener('click', () => changeWeek(7));
                mobileCalendarContainer.querySelector('#mobilePrevWeek')?.addEventListener('click', () => changeWeek(-7));
                mobileCalendarContainer.querySelector('#mobileNextWeek')?.addEventListener('click', () => changeWeek(7));
            }
            
            function generatePCGridCalendar(startDate) {
                calendarContainer.className = 'time-slot-calendar';
                const daysInWeek = Array.from({length: 7}, (_, i) => new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + i - startDate.getDay() + (startDate.getDay() === 0 ? -6 : 1)));
            
                const calendarNavigation = document.createElement('div');
                calendarNavigation.className = 'calendar-navigation';
                const firstDayFormatted = `${dayNamesFull[daysInWeek[0].getDay()].substring(0,3)}. ${daysInWeek[0].getDate()} ${monthNames[daysInWeek[0].getMonth()].substring(0,3)}.`;
                const lastDayFormatted = `${dayNamesFull[daysInWeek[6].getDay()].substring(0,3)}. ${daysInWeek[6].getDate()} ${monthNames[daysInWeek[6].getMonth()].substring(0,3)}.`;
                calendarNavigation.innerHTML = `<button id="prevWeek">Poprzedni tydzień</button><h3>${firstDayFormatted} - ${lastDayFormatted}</h3><button id="nextWeek">Następny tydzień</button>`;
                calendarContainer.appendChild(calendarNavigation);
            
                const table = document.createElement('table');
                table.className = 'calendar-grid-table';
                let headerRow = '<tr><th class="time-label">Godzina</th>';
                daysInWeek.forEach(day => {
                    headerRow += `<th>${dayNamesFull[day.getDay()]}<br>${String(day.getDate()).padStart(2, '0')} ${monthNames[day.getMonth()].substring(0, 3)}</th>`;
                });
                headerRow += '</tr>';
                table.createTHead().innerHTML = headerRow;
                
                const tbody = table.createTBody();
                const twelveHoursFromNow = new Date(Date.now() + 12 * 60 * 60 * 1000);
            
                // Zbieramy wszystkie unikalne godziny z dostępnych terminów
                const allAvailableTimes = new Set();
                Object.values(availableSlotsData).forEach(daySlots => {
                    daySlots.forEach(slot => allAvailableTimes.add(slot.time));
                });
                // Sortujemy godziny
                const sortedTimes = Array.from(allAvailableTimes).sort();

                if (sortedTimes.length === 0) {
                    const row = tbody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 8;
                    cell.style.textAlign = 'center';
                    cell.style.padding = '2rem';
                    cell.textContent = "Brak dostępnych terminów u tego korepetytora w tym tygodniu.";
                } else {
                    sortedTimes.forEach(timeSlot => {
                        const row = tbody.insertRow();
                        row.insertCell().outerHTML = `<td class="time-label">${timeSlot}</td>`;
                        daysInWeek.forEach(day => {
                            const cell = row.insertCell();
                            const formattedDate = getFormattedDate(day);
                            const blockId = `block_${formattedDate}_${timeSlot.replace(':', '')}`;
                            const matchingSlot = (availableSlotsData[formattedDate] || []).find(slot => slot.time === timeSlot);
                            const blockDateTime = new Date(`${formattedDate}T${timeSlot}`);

                            const block = document.createElement('div');
                            block.className = 'time-block';
                            block.dataset.slotId = blockId;
                            
                            if (matchingSlot && blockDateTime > twelveHoursFromNow) {
                                block.textContent = timeSlot;
                                block.addEventListener('click', () => selectSlot(blockId, block, formattedDate, timeSlot));
                                if (newSelectedSlotId === blockId) block.classList.add('selected');
                            } else {
                                block.classList.add('disabled');
                                if (matchingSlot) {
                                    block.textContent = timeSlot;
                                    block.title = "Tego terminu nie można już zarezerwować (mniej niż 12h).";
                                }
                            }
                            cell.appendChild(block);
                        });
                    });
                }
                calendarContainer.appendChild(table);
            }

            function generateMobileListCalendar(startDate) {
                const daysInWeek = Array.from({length: 7}, (_, i) => new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + i - startDate.getDay() + (startDate.getDay() === 0 ? -6 : 1)));
            
                const calendarNavigation = document.createElement('div');
                calendarNavigation.className = 'calendar-navigation';
                const firstDayFormatted = `${dayNamesFull[daysInWeek[0].getDay()].substring(0,3)}. ${daysInWeek[0].getDate()} ${monthNames[daysInWeek[0].getMonth()].substring(0,3)}.`;
                const lastDayFormatted = `${dayNamesFull[daysInWeek[6].getDay()].substring(0,3)}. ${daysInWeek[6].getDate()} ${monthNames[daysInWeek[6].getMonth()].substring(0,3)}.`;
                calendarNavigation.innerHTML = `<button id="mobilePrevWeek">Poprzedni tydzień</button><h3>${firstDayFormatted} - ${lastDayFormatted}</h3><button id="mobileNextWeek">Następny tydzień</button>`;
                mobileCalendarContainer.appendChild(calendarNavigation);

                const twelveHoursFromNow = new Date(Date.now() + 12 * 60 * 60 * 1000);
                let hasSlots = false;

                daysInWeek.forEach(day => {
                    const formattedDate = getFormattedDate(day);
                    const slots = (availableSlotsData[formattedDate] || []).filter(slot => new Date(`${formattedDate}T${slot.time}`) > twelveHoursFromNow);

                    if (slots.length > 0) {
                        hasSlots = true;
                        const dayCard = document.createElement('div');
                        dayCard.className = 'mobile-day-card';
                        dayCard.innerHTML = `<h4>${dayNamesFull[day.getDay()]} ${day.getDate()} ${monthNames[day.getMonth()]}</h4>`;
                        const slotsContainer = document.createElement('div');
                        slotsContainer.className = 'mobile-slots-container';
                        
                        slots.forEach(slot => {
                            const blockId = `block_${formattedDate}_${slot.time.replace(':', '')}`;
                            const block = document.createElement('div');
                            block.className = `time-block ${newSelectedSlotId === blockId ? 'selected' : ''}`;
                            block.dataset.slotId = blockId;
                            block.textContent = slot.time;
                            block.addEventListener('click', () => selectSlot(blockId, block, formattedDate, slot.time));
                            slotsContainer.appendChild(block);
                        });
                        dayCard.appendChild(slotsContainer);
                        mobileCalendarContainer.appendChild(dayCard);
                    }
                });

                if (!hasSlots) {
                    mobileCalendarContainer.innerHTML += '<p style="padding: 2rem; text-align: center; color: var(--text-medium);">Brak dostępnych terminów w tym tygodniu.</p>';
                }
            }

            function changeWeek(days) {
                currentWeekStart.setDate(currentWeekStart.getDate() + days);
                newSelectedSlotId = null;
                newSelectedDate = null;
                newSelectedTime = null;
                newSelectionInfo.textContent = 'Brak';
                rescheduleButton.disabled = true;
                fetchAvailableSlots(currentWeekStart);
            }
        });

        // Funkcje pomocy
        function openHelpModal() {
            document.getElementById('helpModal').classList.add('show');
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('show');
        }

        // Zamknij modal po kliknięciu gdzie indziej
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('helpModal');
            if (modal && event.target == modal) {
                modal.classList.remove('show');
            }
        });
    </script>

    <!-- Modal pomocy -->
    <div id="helpModal" class="help-modal">
        <div class="help-modal-content">
            <span class="close" onclick="closeHelpModal()">&times;</span>
            <h2>Zarządzanie Rezerwacją</h2>
            
            <h3>Jak zmienić termin lekcji:</h3>
            <ul>
                <li>Wybierz <strong>nowy zielony termin</strong> w kalendarzu po prawej stronie</li>
                <li>Naciśnij przycisk <strong>"Zmień termin"</strong></li>
                <li>Zmiana terminu na kolejny tydzień <strong>nie anuluje</strong> przyszłych zajęć z bieżącego tygodnia</li>
            </ul>
            
            <h3>Co się dzieje po odwołaniu lekcji:</h3>
            <ul>
                <li>Lekcja <strong>zniknie z Twojego grafiku</strong> i zostanie przeniesiona do zakończonych lekcji</li>
                <li><strong>Zwrot kosztów</strong> przysługuje tylko jeśli lekcja była opłacona:</li>
                <ul>
                    <li>Otrzymasz <strong>pełny zwrot (100%)</strong> przy odwołaniu minimum <strong>12 godzin</strong> przed rozpoczęciem</li>
                    <li>Dla lekcji testowych: minimum <strong>6 godzin</strong> przed rozpoczęciem</li>
                </ul>
                <li>Jeśli lekcja nie była jeszcze opłacona, nie ma zwrotu kosztów</li>
            </ul>
        </div>
    </div>
</body>
</html>
