<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zarządzaj rezerwacją - Zakręcone Korepetycje</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .edit-container { display: flex; gap: 2rem; max-width: 1200px; margin: 2.5rem auto; }
        .details-panel, .calendar-panel { background-color: var(--container-bg-color); border-radius: 16px; box-shadow: 0 8px 24px var(--shadow-color); padding: 2.5rem; }
        .details-panel { flex: 1; }
        .calendar-panel { flex: 2; }
        .details-panel h2 { margin-top: 0; }
        .details-item { margin-bottom: 1rem; font-size: 1.1rem; }
        .details-item strong { color: var(--text-dark); }
        .details-item span { color: var(--text-medium); }
        .action-buttons { margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; }
        .btn-danger { background-color: #DC3545; color: white; }
        .btn-danger:hover { background-color: #C82333; }
        .btn:disabled { background-color: #E0E0E0; color: var(--text-light); cursor: not-allowed; }
        .time-limit-info { margin-top: 1rem; font-size: 0.9rem; color: var(--text-light); }
    </style>
</head>
<body>
    <header><h1>Zarządzaj rezerwacją</h1></header>

    <main id="loadingState" class="container" style="text-align: center; padding: 4rem;">
        <h2>Ładowanie danych rezerwacji...</h2>
    </main>

    <main id="editState" class="edit-container" style="display: none;">
        <aside class="details-panel">
            <h2>Twoja rezerwacja</h2>
            <div id="reservationDetails"></div>
            <div class="action-buttons">
                <button id="rescheduleButton" class="btn" disabled>Zmień termin</button>
                <button id="cancelButton" class="btn btn-danger" disabled>Odwołaj lekcję</button>
            </div>
            <p id="timeLimitInfo" class="time-limit-info"></p>
        </aside>

        <section class="calendar-panel">
            <h2>Wybierz nowy termin</h2>
            <p>Dostępne terminy dla korepetytora: <strong id="tutorNameInfo"></strong></p>
            <p>Aktualnie wybrany: <strong id="newSelectionInfo">Brak</strong></p>
            <div id="calendar-container">
                <p>Ładowanie dostępnych terminów...</p>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingState = document.getElementById('loadingState');
            const editState = document.getElementById('editState');
            const detailsElement = document.getElementById('reservationDetails');
            const timeLimitInfo = document.getElementById('timeLimitInfo');
            const cancelButton = document.getElementById('cancelButton');
            const rescheduleButton = document.getElementById('rescheduleButton');
            const newSelectionInfo = document.getElementById('newSelectionInfo');
            const calendarContainer = document.getElementById('calendar-container');
            const tutorNameInfo = document.getElementById('tutorNameInfo');
            
            let originalTutor = null;
            let originalDate = null;
            let originalTime = null;
            let clientID = null; // Zapiszemy tu ID klienta

            const API_BASE_URL = 'https://zakręcone-korepetycje.pl'; // Zmień na URL produkcyjny

            const monthNames = ["Sty", "Lut", "Mar", "Kwi", "Maj", "Cze", "Lip", "Sie", "Wrz", "Paź", "Lis", "Gru"];
            const dayNamesFull = ["Niedziela", "Poniedziałek", "Wtorek", "Środa", "Czwartek", "Piątek", "Sobota"];
            const workingHoursStart = 8, workingHoursEnd = 22;

            let availableSlotsData = {};
            let currentWeekStart = getMonday(new Date());
            let newSelectedDate = null;
            let newSelectedTime = null;
            let newSelectedSlotId = null;

            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');

            if (!token) {
                loadingState.innerHTML = '<h2>Błąd: Brak identyfikatora rezerwacji w linku.</h2>';
                return;
            }

            try {
                const details = await fetchReservationDetails(token);
                displayReservationDetails(details);
                loadingState.style.display = 'none';
                editState.style.display = 'flex';
                await fetchAvailableSlots(currentWeekStart);
            } catch (error) {
                console.error("Błąd w głównej logice:", error);
                loadingState.innerHTML = `<h2>Wystąpił błąd: ${error.message}</h2>`;
            }

            cancelButton.addEventListener('click', async () => {
                if (confirm("Czy na pewno chcesz odwołać tę lekcję? Tej operacji nie można cofnąć.")) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/cancel-reservation`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: token })
                        });
                        if (!response.ok) throw new Error((await response.json()).message || "Nie udało się odwołać lekcji.");
                        alert("Lekcja została odwołana.");
                        if (clientID) {
                            window.location.href = `moje-lekcje.html?clientID=${clientID}`;
                        } else {
                            window.location.href = 'index.html';
                        }
                    } catch (error) {
                        alert(`Błąd: ${error.message}`);
                    }
                }
            });
            
            rescheduleButton.addEventListener('click', async () => {
                if (!newSelectedDate || !newSelectedTime) {
                    alert("Proszę wybrać nowy termin z kalendarza.");
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE_URL}/api/reschedule-reservation`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: token, newDate: newSelectedDate, newTime: newSelectedTime })
                    });
                    if (!response.ok) throw new Error((await response.json()).message || "Nie udało się zmienić terminu.");
                    
                    alert((await response.json()).message);
                    
                    if (clientID) {
                        window.location.href = `moje-lekcje.html?clientID=${clientID}`;
                    } else {
                        window.location.reload();
                    }

                } catch (error) {
                    alert(`Błąd: ${error.message}`);
                }
            });

            async function fetchReservationDetails(token) {
                const url = `${API_BASE_URL}/api/get-reservation-details?token=${token}`;
                const response = await fetch(url);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Nie można załadować danych rezerwacji. Serwer odpowiedział błędem ${response.status}.`);
                }
                const details = await response.json();
                originalTutor = details.tutor;
                originalDate = details.date;
                originalTime = details.time;
                clientID = details.clientID; // Zapisz ID klienta
                return details;
            }

            function displayReservationDetails(details) {
                tutorNameInfo.textContent = details.tutor;
                detailsElement.innerHTML = `
                    <div class="details-item"><strong>Uczeń:</strong> <span>${details.student}</span></div>
                    <div class="details-item"><strong>Korepetytor:</strong> <span>${details.tutor}</span></div>
                    <div class="details-item"><strong>Termin:</strong> <span>${details.date} o ${details.time}</span></div>
                `;
                if (details.isCancellationAllowed) {
                    cancelButton.disabled = false;
                    timeLimitInfo.textContent = "Możesz odwołać lub zmienić termin do 12 godzin przed rozpoczęciem zajęć.";
                } else {
                    timeLimitInfo.textContent = "Pozostało mniej niż 12 godzin do rozpoczęcia zajęć. Nie można już zarządzać tym terminem.";
                }
            }

            function selectSlot(slotId, element, date, time) {
                const prevSelected = document.querySelector('.time-block.selected');
                if (prevSelected) prevSelected.classList.remove('selected');
                element.classList.add('selected');
                
                newSelectedSlotId = slotId;
                newSelectedDate = date;
                newSelectedTime = time;
                
                newSelectionInfo.textContent = `${date} o ${time}`;
                if (!cancelButton.disabled) {
                    rescheduleButton.disabled = false;
                }
            }
            
            function getMonday(d) {
                d = new Date(d);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            }
            function getFormattedDate(date) {
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            }

            async function fetchAvailableSlots(startDate) {
                if (!originalTutor) {
                    calendarContainer.innerHTML = `<p style="color: red;">Błąd: Brak informacji o korepetytorze.</p>`;
                    return;
                }
                try {
                    const params = new URLSearchParams({
                        startDate: getFormattedDate(startDate),
                        tutorName: originalTutor
                    });
                    const response = await fetch(`${API_BASE_URL}/api/get-schedule?${params.toString()}`);
                    if (!response.ok) throw new Error('Błąd pobierania grafiku z serwera.');
                    
                    const scheduleFromApi = await response.json();
                    
                    const processedData = {};
                    scheduleFromApi.forEach(slot => {
                        if (slot.status === 'available') {
                           if (!processedData[slot.date]) processedData[slot.date] = [];
                           processedData[slot.date].push(slot);
                        }
                    });
                    availableSlotsData = processedData;
                    generateTimeSlotCalendar(startDate);
                } catch (error) {
                    calendarContainer.innerHTML = `<p style="color: red;">${error.message}</p>`;
                }
            }
            
            
            function generateTimeSlotCalendar(startDate) {
                calendarContainer.innerHTML = '';
                calendarContainer.className = 'time-slot-calendar';
                
                const daysInWeek = Array.from({length: 7}, (_, i) => {
                    const d = new Date(startDate);
                    d.setDate(d.getDate() + i);
                    return d;
                });
            
                const calendarNavigation = document.createElement('div');
                calendarNavigation.className = 'calendar-navigation';
                const firstDayFormatted = `${dayNamesFull[daysInWeek[0].getDay()].substring(0,3)}. ${daysInWeek[0].getDate()} ${monthNames[daysInWeek[0].getMonth()].substring(0,3)}.`;
                const lastDayFormatted = `${dayNamesFull[daysInWeek[6].getDay()].substring(0,3)}. ${daysInWeek[6].getDate()} ${monthNames[daysInWeek[6].getMonth()].substring(0,3)}.`;
                calendarNavigation.innerHTML = `
                    <button id="prevWeek">Poprzedni tydzień</button>
                    <h3>${firstDayFormatted} - ${lastDayFormatted}</h3>
                    <button id="nextWeek">Następny tydzień</button>
                `;
                calendarContainer.appendChild(calendarNavigation);
            
                const table = document.createElement('table');
                table.className = 'calendar-grid-table';
                let headerRow = '<tr><th class="time-label">Godzina</th>';
                daysInWeek.forEach(day => {
                    headerRow += `<th>${dayNamesFull[day.getDay()]}<br>${String(day.getDate()).padStart(2, '0')} ${monthNames[day.getMonth()].substring(0, 3)}</th>`;
                });
                headerRow += '</tr>';
                table.createTHead().innerHTML = headerRow;
                
                const tbody = table.createTBody();
                
                let currentTime = new Date(startDate);
                currentTime.setHours(workingHoursStart, 0, 0, 0);
                const endTime = new Date(startDate);
                endTime.setHours(workingHoursEnd, 0, 0, 0);
            
                // ### NOWA LOGIKA: Oblicz moment 12 godzin od teraz ###
                const twelveHoursFromNow = new Date();
                twelveHoursFromNow.setHours(twelveHoursFromNow.getHours() + 12);
            
                while (currentTime < endTime) {
                    const timeSlot = currentTime.toTimeString().substring(0, 5);
                    
                    const row = tbody.insertRow();
                    row.insertCell().outerHTML = `<td class="time-label">${timeSlot}</td>`;
                    
                    daysInWeek.forEach(day => {
                        const cell = row.insertCell();
                        const formattedDate = getFormattedDate(day);
                        const blockId = `block_${formattedDate}_${timeSlot.replace(':', '')}`;
                        
                        const daySlots = availableSlotsData[formattedDate] || [];
                        const matchingSlot = daySlots.find(slot => slot.time === timeSlot);
                        
                        const block = document.createElement('div');
                        block.className = 'time-block';
                        block.dataset.slotId = blockId;
                        block.dataset.date = formattedDate;
                        block.dataset.time = timeSlot;
                        
                        let isClickable = false;
                        
                        // ### ZMIANA TUTAJ: Dodatkowa walidacja czasu ###
                        const blockDateTime = new Date(`${formattedDate}T${timeSlot}:00`);
            
                        if (matchingSlot && blockDateTime > twelveHoursFromNow) {
                            // Warunek spełniony: slot jest dostępny i jest za ponad 12 godzin
                            block.textContent = timeSlot;
                            isClickable = true;
                        } else {
                            // W przeciwnym razie slot jest niedostępny (zajęty, minął, lub jest za mniej niż 12h)
                            block.classList.add('disabled');
                            if (matchingSlot) { // Jeśli istniał, ale jest za blisko w czasie
                                 block.textContent = timeSlot;
                                 block.title = "Tego terminu nie można już zarezerwować (mniej niż 12h).";
                            }
                        }
            
                        // 'selectedSlotId' jest zdefiniowany globalnie w każdym skrypcie
                        const currentSelectedSlotId = typeof newSelectedSlotId !== 'undefined' ? newSelectedSlotId : selectedSlotId;
                        if(currentSelectedSlotId === blockId) {
                            block.classList.add('selected');
                        }
                        
                        if(isClickable) {
                            block.addEventListener('click', () => selectSlot(blockId, block, formattedDate, timeSlot));
                        }
                        
                        cell.appendChild(block);
                    });
            
                    currentTime.setMinutes(currentTime.getMinutes() + 70);
                }
                
                calendarContainer.appendChild(table);
            
                document.getElementById('prevWeek').addEventListener('click', () => changeWeek(-7));
                document.getElementById('nextWeek').addEventListener('click', () => changeWeek(7));
            }

            function changeWeek(days) {
                currentWeekStart.setDate(currentWeekStart.getDate() + days);
                newSelectedSlotId = null;
                newSelectedDate = null;
                newSelectedTime = null;
                newSelectionInfo.textContent = 'Brak';
                rescheduleButton.disabled = true;
                fetchAvailableSlots(currentWeekStart);
            }
        });
    </script>
</body>
</html>
