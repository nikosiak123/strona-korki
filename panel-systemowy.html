<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Systemowy - Zakręcone Korepetycje</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* RESET & BASE */
        :root {
            --sidebar-width: 250px;
            --header-height: 60px;
            --primary-color: #F2C94C;
            --primary-dark: #dcb338;
            --text-color: #333;
            --bg-color: #f0f2f5;
            --sidebar-bg: #1e1e2d;
            --sidebar-text: #a2a3b7;
            --sidebar-active-bg: #1b1b28;
            --sidebar-active-text: #ffffff;
            --card-bg: #ffffff;
            --border-color: #e4e6ef;
        }

        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
        }

        /* LOGIN SCREEN */
        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: var(--bg-color);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 2000;
        }
        
        .login-box {
            background: white;
            padding: 2.5rem;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        /* LAYOUT STRUCTURE */
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* SIDEBAR */
        .admin-sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 1000;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar-brand {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            background-color: #1a1a27;
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .sidebar-menu {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }

        .menu-item {
            padding: 0.8rem 1.5rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-weight: 500;
        }

        .menu-item:hover {
            background-color: rgba(255,255,255,0.05);
            color: var(--sidebar-active-text);
        }

        .menu-item.active {
            background-color: var(--sidebar-active-bg);
            color: var(--sidebar-active-text);
            border-left-color: var(--primary-color);
        }

        .menu-item i {
            width: 25px;
            margin-right: 10px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .logout-btn {
            width: 100%;
            padding: 0.75rem;
            background-color: rgba(255,255,255,0.1);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        .logout-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }

        /* MAIN CONTENT */
        .admin-main {
            flex: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: calc(100% - var(--sidebar-width));
            transition: margin-left 0.3s ease;
            overflow-x: hidden;
        }

        .top-header {
            height: var(--header-height);
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 900;
        }
        
        .page-title {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
            color: #181c32;
        }

        .mobile-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #333;
            cursor: pointer;
        }

        .content-container {
            padding: 2rem;
            flex: 1;
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* CARDS & PANELS */
        .panel-card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.03);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            width: 100%;
            box-sizing: border-box;
        }

        /* UTILS */
        .hidden { display: none !important; }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .btn-primary { background-color: var(--primary-color); color: #333; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        
        .btn-success { background-color: #1bc5bd; color: white; }
        .btn-success:hover { background-color: #0bb7af; }
        
        .btn-danger { background-color: #f64e60; color: white; }
        .btn-danger:hover { background-color: #ee2d41; }

        .btn-info { background-color: #3699ff; color: white; }
        .btn-info:hover { background-color: #187de4; }

        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

        /* TABLES */
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding-bottom: 5px; /* Space for scrollbar */
        }

        /* Custom Scrollbar for Table - Forced Visibility */
        .table-responsive::-webkit-scrollbar {
            height: 12px;
            display: block;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #a0a0a0; /* Darker for better visibility */
            border-radius: 4px;
            border: 2px solid #f1f1f1;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Firefox support */
        .table-responsive {
            scrollbar-width: auto;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            min-width: 1200px; /* Force wider table to ensure scrollbar appears */
        }
        
        th, td {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            vertical-align: middle;
            white-space: nowrap; /* Prevent wrapping */
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        th {
            background-color: #f9f9fc;
            text-align: left;
            font-weight: 600;
            color: #b5b5c3;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover td {
            background-color: #f9f9fc;
        }
        
        th {
            background-color: #f9f9fc;
            text-align: left;
            padding: 1rem;
            font-weight: 600;
            color: #b5b5c3;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            vertical-align: middle;
        }
        
        tr:hover td {
            background-color: #f9f9fc;
        }

        /* FORMS */
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            background-color: #fff;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 1.5rem;
            position: relative;
        }

        /* CHAT SPECIFIC */
        .chat-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 1.5rem;
            height: calc(100vh - 180px); /* Dopasowanie do wysokości */
            min-height: 500px;
        }

        .user-list {
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            padding-right: 1rem;
        }

        .chat-area {
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #fff;
            overflow: hidden;
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            background: #f9f9fc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message-bubble {
            max-width: 80%;
            padding: 0.8rem 1.2rem;
            border-radius: 12px;
            position: relative;
            line-height: 1.4;
        }

        .msg-bot {
            align-self: flex-start;
            background-color: #f0f2f5;
            color: #333;
            border-bottom-left-radius: 2px;
        }

        .msg-user {
            align-self: flex-end;
            background-color: #e1f0ff; /* Lekki niebieski */
            color: #0050a5;
            border-bottom-right-radius: 2px;
        }
        
        .msg-user.unread {
            border: 2px solid var(--primary-color);
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: #f9f9fc;
            display: flex;
            gap: 10px;
        }

        .user-item {
            padding: 1rem;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid transparent;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
            background: #fff;
            border: 1px solid var(--border-color);
        }

        .user-item:hover {
            background-color: #f9f9fc;
            border-color: #d1d3e0;
        }

        .user-item.active {
            background-color: #e1f0ff;
            border-color: #b5d0f5;
        }
        
        .user-item.has-unread {
            border-left: 4px solid var(--primary-color);
        }

        /* MODALS */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* RESPONSIVE */
        @media (max-width: 992px) {
            .admin-sidebar {
                transform: translateX(-100%);
            }
            .admin-main {
                margin-left: 0;
            }
            .sidebar-open .admin-sidebar {
                transform: translateX(0);
            }
            .mobile-toggle {
                display: block;
            }
            .chat-layout {
                grid-template-columns: 1fr;
            }
            .user-list {
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                margin-bottom: 1rem;
            }
        }
        .tutor-card-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .tutor-card-item:hover {
            background-color: #f9f9fc;
        }
        .tutor-avatar {
            width: 40px;
            height: 40px;
            background-color: #e1f0ff;
            color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 15px;
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-box">
            <h2 style="margin-bottom: 1.5rem; color: #181c32;">Panel Systemowy</h2>
            <div style="margin-bottom: 1.5rem;">
                <input type="password" id="passwordInput" class="form-control" placeholder="Hasło dostępu" />
            </div>
            <button id="loginBtn" class="btn btn-primary" style="width: 100%; justify-content: center;">Zaloguj</button>
            <p id="loginError" style="color: #f64e60; margin-top: 10px; display: none;">Nieprawidłowe hasło</p>
        </div>
    </div>

    <!-- Admin Panel Layout -->
    <div id="adminPanel" class="admin-wrapper" style="display: none;">
        
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-brand">
                <i class="fas fa-shield-alt" style="margin-right: 10px; color: var(--primary-color);"></i>
                Zakręcone Korepetycje
            </div>
            
            <nav class="sidebar-menu">
                <div class="menu-item active" data-target="database">
                    <i class="fas fa-database"></i>
                    <span>Baza Danych</span>
                </div>
                <div class="menu-item" data-target="tutors">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Korepetytorzy</span>
                </div>
                <div class="menu-item" data-target="messages">
                    <i class="fas fa-comments"></i>
                    <span>Wiadomości</span>
                </div>
                <div class="menu-item" data-target="stats">
                    <i class="fas fa-chart-line"></i>
                    <span>Bot Facebook</span>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Wyloguj
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Top Header -->
            <header class="top-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button id="mobileMenuToggle" class="mobile-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="headerTitle">Baza Danych</h1>
                </div>
                <div style="font-size: 0.9rem; color: #7e8299;">
                    <i class="far fa-user"></i> Administrator
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-container">
                
                <!-- VIEW: DATABASE -->
                <div id="view-database" class="panel-view">
                    <div class="panel-card">
                        <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="table-tabs" style="display: flex; gap: 0.5rem; overflow-x: auto;">
                                <button class="btn btn-sm btn-info table-selector active" data-table="Klienci">Klienci</button>
                                <button class="btn btn-sm btn-info table-selector" data-table="Korepetytorzy">Korepetytorzy</button>
                                <button class="btn btn-sm btn-info table-selector" data-table="Rezerwacje">Rezerwacje</button>
                                <button class="btn btn-sm btn-info table-selector" data-table="StaleRezerwacje">Stałe</button>
                            </div>
                            
                            <div class="actions" style="display: flex !important; gap: 10px; margin-left: auto; align-items: center;">
                                <button id="resetTestUserBtn" class="btn btn-sm btn-primary">
                                    <i class="fas fa-sync"></i> Reset Testowy
                                </button>
                                <button class="btn btn-sm btn-success" onclick="openAddModal()">
                                    <i class="fas fa-plus"></i> Dodaj Rekord
                                </button>
                                <button id="quickTutorBtn" class="btn btn-sm btn-info hidden" onclick="openSimpleTutorAddModal()">
                                    <i class="fas fa-user-plus"></i> Szybki Korepetytor
                                </button>
                            </div>
                        </div>

                        <div id="databaseContent">
                            <p style="text-align: center; color: #7e8299; padding: 2rem;">Wybierz tabelę powyżej...</p>
                        </div>
                    </div>
                </div>

                <!-- VIEW: TUTORS -->
                <div id="view-tutors" class="panel-view hidden">
                    <div class="panel-card">
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="margin: 0;">Lista Korepetytorów</h3>
                        </div>
                        <div id="tutorsListContent">
                            <p style="text-align: center; color: #999;">Ładowanie listy...</p>
                        </div>
                    </div>
                </div>

                <!-- VIEW: TUTOR DETAILS (Dynamic) -->
                <div id="view-tutor-details" class="panel-view hidden">
                    <div class="panel-card">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                            <button class="btn btn-sm" onclick="backToTutorsList()" style="background: #e4e6ef; color: #333;">
                                <i class="fas fa-arrow-left"></i> Wróć
                            </button>
                            <div>
                                <h2 style="margin: 0;" id="tutorDetailsName">Imię Nazwisko</h2>
                                <span style="font-size: 0.9rem; color: #7e8299;" id="tutorDetailsId">ID: ...</span>
                            </div>
                        </div>

                        <div id="tutorManagementContent">
                            <p style="padding: 2rem; text-align: center; color: #999;">
                                <i class="fas fa-tools" style="font-size: 2rem; margin-bottom: 1rem;"></i><br>
                                Panel zarządzania korepetytorem - funkcje wkrótce...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- VIEW: MESSAGES -->
                <div id="view-messages" class="panel-view hidden">
                    <div class="panel-card" style="height: 100%;">
                        <div class="search-bar" style="position: relative;">
                            <div style="flex:1; position:relative;">
                                <input type="text" id="searchUser" class="form-control" placeholder="Szukaj użytkownika (Imię, Nazwisko, PSID)...">
                                <div id="autocomplete-results" style="display:none; border:1px solid #ddd; border-radius:4px; max-height:200px; overflow:auto; position:absolute; top: 100%; left: 0; right: 0; background:white; z-index:1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                            </div>
                            <button id="btnSearchUser" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </div>

                        <div class="chat-layout">
                            <!-- Left: User List -->
                            <div class="user-list">
                                <h3 style="margin-top: 0; font-size: 1rem; color: #7e8299; text-transform: uppercase;">Użytkownicy (Manual)</h3>
                                <div id="manualUsersList">
                                    <p style="text-align: center; color: #999;">Ładowanie...</p>
                                </div>
                            </div>

                            <!-- Right: Chat Area -->
                            <div class="chat-area" id="chatWrapper" style="display: none;">
                                <div class="chat-header">
                                    <div>
                                        <strong id="chatUserNameDisplay">Użytkownik</strong>
                                        <div style="font-size: 0.8rem; color: #7e8299;" id="chatUserPsidDisplay">PSID: ...</div>
                                    </div>
                                    <div style="display: flex; gap: 5px;">
                                        <a id="clientLink" href="#" target="_blank" class="btn btn-sm btn-info" title="Panel klienta"><i class="fas fa-external-link-alt"></i></a>
                                        <button id="toggleManualModeBtn" class="btn btn-sm btn-danger">Wyłącz Manual</button>
                                    </div>
                                </div>
                                
                                <div class="chat-messages" id="chatMessagesBox"></div>
                                
                                <div class="chat-input-area">
                                    <input type="text" id="msgInput" class="form-control" placeholder="Napisz wiadomość..." style="border-radius: 20px;">
                                    <button id="sendMsgBtn" class="btn btn-primary" style="border-radius: 50%; width: 42px; height: 42px; padding: 0; display: flex; align-items: center; justify-content: center;"><i class="fas fa-paper-plane"></i></button>
                                </div>

                                <div style="padding: 10px; border-top: 1px solid #eee; background: #fafafa; font-size: 0.85rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span id="userDetailsFooter">Saldo: -</span>
                                        <button id="sendLinkActionBtn" class="btn btn-sm btn-primary" style="font-size: 0.75rem;">Wyślij link rezerwacyjny</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="chatPlaceholder" style="display: flex; align-items: center; justify-content: center; color: #999; flex-direction: column;">
                                <i class="far fa-comments" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                                <p>Wybierz użytkownika z listy, aby rozpocząć czat</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: STATS -->
                <div id="view-stats" class="panel-view hidden">
                    
                    <!-- Bot Status Card - always visible -->
                    <div id="botStatusCard" style="margin-bottom: 1.5rem;">
                       <!-- Dynamically injected status -->
                    </div>

                    <div class="panel-card" style="padding: 0; border: none; box-shadow: none; background: transparent;">
                        <div class="stats-tabs">
                            <button class="stats-tab-btn active" data-target="stats-statystyki">Statystyki</button>
                            <button class="stats-tab-btn" data-target="stats-bledy">Błędy</button>
                            <button class="stats-tab-btn" data-target="stats-dzialanie">Działanie</button>
                            <button class="stats-tab-btn" data-target="stats-komentarze">Log Komentarzy</button>
                        </div>
                    </div>

                    <!-- Tab Content -->
                    <div id="stats-statystyki" class="stats-tab-content">
                         <div id="dailySummaryContainer">
                            <!-- Daily summary table will be injected here -->
                         </div>
                    </div>

                    <div id="stats-bledy" class="stats-tab-content hidden">
                        <div class="panel-card">
                            <h3 style="margin-top: 0;">Ostatnie Logi/Błędy</h3>
                            <div id="errorLogsList" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </div>

                    <div id="stats-dzialanie" class="stats-tab-content hidden">
                        <div class="panel-card" style="margin-bottom: 1.5rem;">
                            <h3 style="margin-top: 0;">Aktywność godzinowa</h3>
                            <div style="height: 300px;">
                                <canvas id="hourlyStatsChart"></canvas>
                            </div>
                        </div>
                        <div class="panel-card">
                            <h3 style="margin-top: 0;">Zrzuty ekranu (Bot Status)</h3>
                            <div id="screenshotList" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </div>

                    <div id="stats-komentarze" class="stats-tab-content hidden">
                        <div class="panel-card">
                            <h3 style="margin-top: 0;">Log ostatnich komentarzy</h3>
                            <div id="commentLogsContainer"></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modal: Generic Edit/Add -->
    <div id="recordModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 1rem;">Edycja</h3>
            <div id="modalFormContainer" style="margin: 1.5rem 0;"></div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn" onclick="closeModal('recordModal')">Anuluj</button>
                <button class="btn btn-primary" id="saveRecordBtn">Zapisz</button>
            </div>
        </div>
    </div>

    <!-- Modal: Simple Tutor -->
    <div id="simpleTutorModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top: 0;">Szybkie dodawanie korepetytora</h3>
            <div style="margin: 1.5rem 0;">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Imię i Nazwisko</label>
                    <input type="text" id="simpleTutorName" class="form-control" placeholder="Jan Kowalski">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Główny przedmiot</label>
                    <select id="simpleTutorSubject" class="form-control">
                        <!-- Options from JS -->
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn" onclick="closeModal('simpleTutorModal')">Anuluj</button>
                <button class="btn btn-primary" id="saveSimpleTutorBtn">Dodaj</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '';
        
        // --- STATE ---
        let state = {
            currentTable: 'Klienci',
            currentUserPSID: null,
            currentRecordId: null,
            currentMode: 'add', // 'add' or 'edit'
            isMobileMenuOpen: false
        };

        const fieldOptions = {
            'Status': ['Oczekuje na płatność', 'Opłacona', 'Anulowana (brak płatności)', 'Odwołana - brak potwierdzenia', 'Przeniesiona', 'Przeniesiona (zakończona)', 'Dostępny', 'Niedostępny'],
            'TypSzkoly': ['szkola_podstawowa', 'liceum', 'technikum'],
            'Poziom': ['podstawowy', 'rozszerzony'],
            'Klasa': ['1', '2', '3', '4', '5', '6', '7', '8'],
            'JestTestowa': ['false', 'true'],
            'Oplacona': ['false', 'true'],
            'confirmed': ['false', 'true'],
            'Aktywna': ['true', 'false'],
            'DzienTygodnia': ['Poniedziałek', 'Wtorek', 'Środa', 'Czwartek', 'Piątek', 'Sobota', 'Niedziela'],
            'Przedmiot': ['matematyka', 'fizyka', 'chemia', 'biologia', 'polski', 'angielski', 'historia', 'geografia', 'informatyka', 'plastyka', 'muzyka'],
            'Przedmioty': ['polski', 'matematyka', 'angielski'],
            'PoziomNauczania': ['podstawowka', 'liceum_podstawa', 'liceum_rozszerzenie']
        };
        const multipleFields = ['Przedmioty', 'PoziomNauczania'];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Check Auth
            await checkAuth();

            // Mobile Menu
            document.getElementById('mobileMenuToggle').addEventListener('click', () => {
                document.getElementById('adminPanel').classList.toggle('sidebar-open');
            });

            // Navigation
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    const target = item.dataset.target;
                    
                    // Update active state
                    document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Switch views
                    document.querySelectorAll('.panel-view').forEach(view => view.classList.add('hidden'));
                    document.getElementById(`view-${target}`).classList.remove('hidden');

                    // Update Header
                    const titles = { 'database': 'Baza Danych', 'messages': 'Wiadomości', 'stats': 'Bot Facebook', 'tutors': 'Korepetytorzy' };
                    document.getElementById('headerTitle').textContent = titles[target];

                    // Close mobile menu
                    document.getElementById('adminPanel').classList.remove('sidebar-open');

                    // Load data if needed
                    if (target === 'database') loadTableData(state.currentTable);
                    if (target === 'messages') loadManualUsers();
                    if (target === 'stats') loadStats();
                    if (target === 'tutors') {
                        state.currentTable = 'Korepetytorzy'; // Ensure correct table context for editing
                        loadTutorsView();
                    }

                    // Save state
                    localStorage.setItem('adminLastView', target);
                });
            });

            // Restore last view
            const lastView = localStorage.getItem('adminLastView') || 'database';
            const navItem = document.querySelector(`.menu-item[data-target="${lastView}"]`);
            if (navItem) navItem.click();

            // Stats Tabs
            document.querySelectorAll('.stats-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = btn.dataset.target;

                    // Button active state
                    document.querySelectorAll('.stats-tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Show/hide content
                    document.querySelectorAll('.stats-tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(target).classList.remove('hidden');
                });
            });

            // Login Handler
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('passwordInput').addEventListener('keypress', e => { if(e.key==='Enter') handleLogin(); });
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Table Selection
            document.querySelectorAll('.table-selector').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.table-selector').forEach(b => {
                        b.classList.remove('active');
                        b.classList.remove('btn-primary');
                        b.classList.add('btn-info');
                    });
                    btn.classList.add('active');
                    btn.classList.remove('btn-info');
                    btn.classList.add('btn-primary');
                    
                    state.currentTable = btn.dataset.table;
                    loadTableData(state.currentTable);
                });
            });

            // Set initial active table button style
            const activeTableBtn = document.querySelector(`.table-selector[data-table="${state.currentTable}"]`);
            if(activeTableBtn) {
                activeTableBtn.classList.remove('btn-info');
                activeTableBtn.classList.add('btn-primary');
            }

            // Modal Handlers
            document.getElementById('saveRecordBtn').addEventListener('click', saveRecord);
            document.getElementById('saveSimpleTutorBtn').addEventListener('click', saveSimpleTutor);
            
            // Search Users
            setupUserSearch();
        });

        // --- AUTH ---
        async function checkAuth() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/admin/check-auth`);
                const data = await res.json();
                if (data.authenticated) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'flex';
                } else {
                    document.getElementById('loginScreen').style.display = 'flex';
                }
            } catch (e) {
                console.error(e);
                document.getElementById('loginScreen').style.display = 'flex';
            }
        }

        async function handleLogin() {
            const password = document.getElementById('passwordInput').value;
            try {
                const res = await fetch(`${API_BASE_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({password})
                });
                const data = await res.json();
                if (data.success) {
                    location.reload();
                } else {
                    document.getElementById('loginError').style.display = 'block';
                }
            } catch (e) { alert('Błąd połączenia'); }
        }

        async function handleLogout() {
            await fetch(`${API_BASE_URL}/api/admin/logout`, {method: 'POST'});
            location.reload();
        }

        // --- DATABASE PANEL ---
        async function loadTableData(tableName) {
            const container = document.getElementById('databaseContent');
            container.innerHTML = '<div style="padding:2rem; text-align:center; color:#999;"><i class="fas fa-spinner fa-spin fa-2x"></i><br><br>Ładowanie danych...</div>';

            // Show/Hide "Quick Tutor" button
            const quickBtn = document.getElementById('quickTutorBtn');
            if(tableName === 'Korepetytorzy') quickBtn.classList.remove('hidden');
            else quickBtn.classList.add('hidden');

            try {
                const res = await fetch(`${API_BASE_URL}/api/admin/table/${tableName}`);
                const data = await res.json();

                if (!data.records || data.records.length === 0) {
                    container.innerHTML = '<div style="padding:2rem; text-align:center;">Brak rekordów. <a href="#" onclick="openAddModal()">Dodaj pierwszy</a></div>';
                    return;
                }

                // Determine columns
                let fields = Object.keys(data.records[0].fields);
                
                // Specific column order for Tutors
                if (tableName === 'Korepetytorzy') {
                    const order = ['TutorID', 'ImieNazwisko', 'LINK', 'Poniedziałek', 'Wtorek', 'Środa', 'Czwartek', 'Piątek', 'Sobota', 'Niedziela', 'Przedmioty', 'PoziomNauczania'];
                    fields = order.filter(f => fields.includes(f)); // Keep only existing
                    // Add remaining if any
                    const remaining = Object.keys(data.records[0].fields).filter(f => !order.includes(f));
                    fields.push(...remaining);
                }

                let html = `<div class="table-responsive"><table><thead><tr><th>ID</th>`;
                fields.forEach(f => html += `<th>${f}</th>`);
                html += `<th>Akcje</th></tr></thead><tbody>`;

                data.records.forEach(rec => {
                    html += `<tr><td><small style="color:#999;">${rec.id}</small></td>`;
                    fields.forEach(f => {
                        let val = rec.fields[f];
                        
                        // Formatting
                        if (Array.isArray(val)) val = val.join(', ');
                        if (val === true) val = '<span style="color:#1bc5bd; font-weight:bold;">Tak</span>';
                        if (val === false) val = '<span style="color:#f64e60;">Nie</span>';
                        if (val === null || val === undefined) val = '';
                        
                        // Links
                        if (tableName === 'Korepetytorzy' && f === 'ImieNazwisko' && rec.fields.TutorID) {
                            val = `<a href="panel-korepetytora.html?tutorID=${rec.fields.TutorID}" target="_blank" style="color:var(--primary-dark); font-weight:bold; text-decoration:none;">${val} <i class="fas fa-external-link-alt" style="font-size:0.7em;"></i></a>`;
                        }
                        if (tableName === 'Klienci' && f === 'Imie' && rec.fields.ClientID) {
                            val = `<a href="moje-lekcje.html?clientID=${rec.fields.ClientID}" target="_blank" style="color:var(--primary-dark); font-weight:bold; text-decoration:none;">${val} <i class="fas fa-external-link-alt" style="font-size:0.7em;"></i></a>`;
                        }

                        html += `<td>${val}</td>`;
                    });
                    
                    html += `
                        <td>
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-sm btn-info" onclick='editRecordInit(${JSON.stringify(rec).replace(/'/g, "'")})'><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="deleteRecord('${rec.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </td></tr>
                    `;
                });
                html += `</tbody></table></div>`;
                
                container.innerHTML = html;

            } catch (e) {
                container.innerHTML = `<div style="color:red; padding:1rem;">Błąd: ${e.message}</div>`;
            }
        }

        // --- CRUD OPERATIONS ---
        function openAddModal() {
            state.currentMode = 'add';
            state.currentRecordId = null;
            document.getElementById('modalTitle').textContent = 'Dodaj nowy rekord';
            
            // Generate empty form based on current table defaults
            const defaults = {
                'Klienci': {ClientID: '', Imie: '', Nazwisko: '', LINK: ''},
                'Korepetytorzy': {TutorID: '', ImieNazwisko: '', LINK: '', Przedmioty: [], PoziomNauczania: []},
                'Rezerwacje': {Klient: '', Korepetytor: '', Data: '', Godzina: '', Status: 'Oczekuje na płatność'},
                'StaleRezerwacje': {Klient_ID: '', Korepetytor: '', DzienTygodnia: '', Godzina: '', Aktywna: true}
            };
            
            generateForm(defaults[state.currentTable] || {});
            openModal('recordModal');
        }

        function editRecordInit(record) {
            state.currentMode = 'edit';
            state.currentRecordId = record.id;
            document.getElementById('modalTitle').textContent = `Edycja rekordu (${record.id})`;
            generateForm(record.fields);
            openModal('recordModal');
        }

        function generateForm(fields) {
            const container = document.getElementById('modalFormContainer');
            let html = '';

            // Sort keys based on table type
            let sortedKeys = Object.keys(fields);
            if (state.currentTable === 'Korepetytorzy') {
                const correctOrder = ['TutorID', 'ImieNazwisko', 'LINK', 'Poniedziałek', 'Wtorek', 'Środa', 'Czwartek', 'Piątek', 'Sobota', 'Niedziela', 'Przedmioty', 'PoziomNauczania'];
                const orderedPart = correctOrder.filter(k => sortedKeys.includes(k));
                const remainingPart = sortedKeys.filter(k => !correctOrder.includes(k));
                sortedKeys = [...orderedPart, ...remainingPart];
            }

            for (const key of sortedKeys) {
                const value = fields[key];
                html += `<div style="margin-bottom:1rem;"><label style="display:block; font-weight:600; font-size:0.9rem; margin-bottom:5px;">${key}</label>`;
                
                if (['Klient', 'Klient_ID', 'Korepetytor'].includes(key)) {
                    const valStr = value || '';
                    const resultsId = `autocomplete-${key}-${Date.now()}`;
                    
                    html += `
                        <div style="position:relative;">
                            <input type="text" name="${key}" class="form-control" value="${String(valStr).replace(/"/g, '"')}" autocomplete="off" oninput="handleModalSearch(this, '${resultsId}', '${key}')" onfocus="handleModalSearch(this, '${resultsId}', '${key}')">
                            <div id="${resultsId}" style="display:none; border:1px solid #ddd; border-radius:4px; max-height:150px; overflow:auto; position:absolute; top:100%; left:0; right:0; background:white; z-index:1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                        </div>
                    `;
                } else if (multipleFields.includes(key)) {
                    // Multiple select box
                    html += `<select name="${key}" class="form-control" multiple style="height: 120px;">`;
                    const options = fieldOptions[key] || [];
                    const selectedValues = Array.isArray(value) ? value : (value ? String(value).split(',').map(s=>s.trim()) : []);
                    options.forEach(opt => {
                        html += `<option value="${opt}" ${selectedValues.includes(opt) ? 'selected' : ''}>${opt}</option>`;
                    });
                    html += `</select>`;
                } else if (fieldOptions[key]) {
                    // Select dropdown
                    html += `<select name="${key}" class="form-control">`;
                    const options = fieldOptions[key];
                    options.forEach(opt => {
                        // Handle boolean values correctly
                        const isSelected = String(value) === String(opt);
                        html += `<option value="${opt}" ${isSelected ? 'selected' : ''}>${opt}</option>`;
                    });
                    html += `</select>`;
                } else {
                    // Text input
                    let valStr = value;
                    if (typeof value === 'object' && value !== null) valStr = JSON.stringify(value);
                    if (valStr === null || valStr === undefined) valStr = '';
                    
                    html += `<input type="text" name="${key}" class="form-control" value="${String(valStr).replace(/"/g, '"')}">`;
                }
                html += `</div>`;
            }
            container.innerHTML = html;
        }

        async function saveRecord() {
            const formData = {};
            const container = document.getElementById('modalFormContainer');
            
            // Inputs
            container.querySelectorAll('input').forEach(inp => {
                let val = inp.value;
                // Auto-detect JSON or Boolean
                if (val === 'true') val = true;
                if (val === 'false') val = false;
                if (val.startsWith('[') || val.startsWith('{')) { try { val = JSON.parse(val); } catch(e){} }
                formData[inp.name] = val;
            });

            // Selects
            container.querySelectorAll('select').forEach(sel => {
                if (sel.multiple) {
                    formData[sel.name] = Array.from(sel.selectedOptions).map(o => o.value);
                } else {
                    let val = sel.value;
                    if (val === 'true') val = true;
                    if (val === 'false') val = false;
                    formData[sel.name] = val;
                }
            });

            try {
                const url = `${API_BASE_URL}/api/admin/table/${state.currentTable}/record` + (state.currentMode === 'edit' ? `/${state.currentRecordId}` : '');
                const method = state.currentMode === 'edit' ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({fields: formData})
                });

                if (res.ok) {
                    closeModal('recordModal');
                    loadTableData(state.currentTable);
                } else {
                    alert('Błąd zapisu');
                }
            } catch (e) { alert('Błąd: ' + e.message); }
        }

        async function deleteRecord(id) {
            if(!confirm('Czy na pewno usunąć?')) return;
            try {
                await fetch(`${API_BASE_URL}/api/admin/table/${state.currentTable}/record/${id}`, {method: 'DELETE'});
                loadTableData(state.currentTable);
            } catch(e) { alert('Błąd usuwania'); }
        }

        // Quick Tutor
        function openSimpleTutorAddModal() {
            const sel = document.getElementById('simpleTutorSubject');
            sel.innerHTML = '';
            (fieldOptions['Przedmiot'] || []).forEach(p => {
                sel.innerHTML += `<option value="${p}">${p}</option>`;
            });
            openModal('simpleTutorModal');
        }

        async function saveSimpleTutor() {
            const name = document.getElementById('simpleTutorName').value;
            const subject = document.getElementById('simpleTutorSubject').value;
            if(!name) return alert('Podaj imię');
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/admin/table/Korepetytorzy/record`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        fields: {
                            "ImieNazwisko": name,
                            "Przedmioty": [subject],
                            "PoziomNauczania": ["podstawowka", "liceum_podstawa"],
                            "TutorID": "temp-" + Date.now()
                        }
                    })
                });
                if(res.ok) {
                    closeModal('simpleTutorModal');
                    loadTableData('Korepetytorzy');
                } else alert('Błąd');
            } catch(e) { alert(e.message); }
        }

        // --- MESSAGES & CHAT ---
        async function loadManualUsers() {
            const list = document.getElementById('manualUsersList');
            list.innerHTML = '<div style="text-align:center; padding:10px;"><i class="fas fa-spinner fa-spin"></i></div>';
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/admin/manual-users`);
                const data = await res.json();
                
                if (data.users.length === 0) {
                    list.innerHTML = '<p style="color:#999; text-align:center;">Brak użytkowników</p>';
                    return;
                }

                data.users.sort((a,b) => (b.unreadCount - a.unreadCount) || a.name.localeCompare(b.name));

                let html = '';
                data.users.forEach(u => {
                    html += `
                        <div class="user-item ${u.unreadCount > 0 ? 'has-unread' : ''}" onclick="openChat('${u.psid}', '${u.name}')">
                            <div style="font-weight:600;">${u.name}</div>
                            <div style="font-size:0.8rem; color:#777; display:flex; justify-content:space-between;">
                                <span>${u.lastMessage ? u.lastMessage.substring(0,25)+'...' : ''}</span>
                                ${u.unreadCount > 0 ? `<span style="background:var(--primary-color); color:#333; padding:1px 6px; border-radius:10px; font-weight:bold;">${u.unreadCount}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html;
            } catch (e) { console.error(e); }
        }

        async function openChat(psid, name) {
            state.currentUserPSID = psid;
            
            document.getElementById('chatWrapper').style.display = 'flex';
            document.getElementById('chatPlaceholder').style.display = 'none';
            
            document.getElementById('chatUserNameDisplay').textContent = name || psid;
            document.getElementById('chatUserPsidDisplay').textContent = `PSID: ${psid}`;
            document.getElementById('clientLink').href = `moje-lekcje.html?clientID=${psid}`;

            // Load Messages
            const box = document.getElementById('chatMessagesBox');
            box.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i></div>';
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/admin/user-chat/${psid}`);
                const data = await res.json();
                
                box.innerHTML = '';
                data.messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `message-bubble ${msg.role === 'user' ? 'msg-user' : 'msg-bot'} ${!msg.read && msg.role==='user' ? 'unread' : ''}`;
                    div.textContent = msg.text;
                    
                    if (msg.role === 'user' && !msg.read) {
                        const check = document.createElement('i');
                        check.className = 'fas fa-check';
                        check.style.marginLeft = '10px';
                        check.style.cursor = 'pointer';
                        check.style.color = 'var(--primary-color)';
                        check.title = 'Oznacz jako przeczytane';
                        check.onclick = () => markAsRead(psid, msg.fullIndex);
                        div.appendChild(check);
                    }
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;

                // Load Details
                loadUserDetails(psid);

            } catch(e) { console.error(e); }
        }

        async function markAsRead(psid, idx) {
            await fetch(`${API_BASE_URL}/api/admin/mark-read/${psid}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({upToFullIndex: idx})
            });
            openChat(psid, document.getElementById('chatUserNameDisplay').textContent); // Reload
            loadManualUsers(); // Refresh list count
        }

        async function loadUserDetails(psid) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/admin/user-details/${psid}`);
                const data = await res.json();
                
                document.getElementById('userDetailsFooter').textContent = `Saldo: ${data.user.freeAmount || 0} zł`;
                
                const btn = document.getElementById('toggleManualModeBtn');
                if (data.user.manualModeActive) {
                    btn.textContent = 'Wyłącz Manual';
                    btn.className = 'btn btn-sm btn-danger';
                    btn.onclick = () => toggleManual(psid, 'end-manual');
                } else {
                    btn.textContent = 'Włącz Manual';
                    btn.className = 'btn btn-sm btn-success';
                    btn.onclick = () => toggleManual(psid, 'enable-manual');
                }

                // Send link handler
                document.getElementById('sendLinkActionBtn').onclick = async () => {
                    if(confirm('Wysłać link?')) {
                        await fetch(`${API_BASE_URL}/api/admin/send-reservation-link`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({psid})
                        });
                        alert('Wysłano');
                    }
                };

            } catch(e) { console.error(e); }
        }

        async function toggleManual(psid, endpoint) {
            if(!confirm('Zmienić tryb manualny?')) return;
            await fetch(`${API_BASE_URL}/api/admin/${endpoint}/${psid}`, {method: 'POST'});
            loadUserDetails(psid);
            loadManualUsers();
        }

        document.getElementById('sendMsgBtn').addEventListener('click', async () => {
            const txt = document.getElementById('msgInput').value;
            if(!txt || !state.currentUserPSID) return;
            
            await fetch(`${API_BASE_URL}/api/admin/send-message`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({psid: state.currentUserPSID, message: txt})
            });
            document.getElementById('msgInput').value = '';
            openChat(state.currentUserPSID, document.getElementById('chatUserNameDisplay').textContent);
        });

        // Search
        function setupUserSearch() {
            const input = document.getElementById('searchUser');
            const results = document.getElementById('autocomplete-results');
            let debounce;
            
            input.addEventListener('input', () => {
                clearTimeout(debounce);
                debounce = setTimeout(async () => {
                    const q = input.value;
                    if(q.length < 1) { results.style.display = 'none'; return; } // Allow single char search for testing
                    
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/admin/search-clients?query=${encodeURIComponent(q)}`);
                        if (!res.ok) throw new Error('Network error');
                        const data = await res.json();
                        
                        if(data.clients && data.clients.length) {
                            results.innerHTML = '';
                            results.style.display = 'block';
                            data.clients.forEach(c => {
                                const div = document.createElement('div');
                                div.style.padding = '10px';
                                div.style.cursor = 'pointer';
                                div.style.borderBottom = '1px solid #eee';
                                div.innerHTML = `<strong>${c.displayName}</strong> <br><small>${c.psid}</small>`;
                                div.onmouseover = () => div.style.backgroundColor = '#f0f2f5';
                                div.onmouseout = () => div.style.backgroundColor = 'white';
                                div.onclick = () => {
                                    openChat(c.psid, c.displayName);
                                    results.style.display = 'none';
                                    input.value = '';
                                };
                                results.appendChild(div);
                            });
                        } else {
                            results.style.display = 'block';
                            results.innerHTML = '<div style="padding:10px; color:#999;">Brak wyników</div>';
                        }
                    } catch (e) {
                        console.error(e);
                        results.style.display = 'block';
                        results.innerHTML = '<div style="padding:10px; color:red;">Błąd wyszukiwania</div>';
                    }
                }, 300);
            });
            
            document.addEventListener('click', e => {
                if(e.target !== input && e.target !== results) results.style.display = 'none';
            });
        }

        // --- AUTOCOMPLETE ---
        let searchDebounce;
        async function handleModalSearch(input, resultsId, type) {
            clearTimeout(searchDebounce);
            const results = document.getElementById(resultsId);
            
            // Close other autocompletes
            document.querySelectorAll('[id^="autocomplete-"]').forEach(el => {
                if (el.id !== resultsId) el.style.display = 'none';
            });

            searchDebounce = setTimeout(async () => {
                const q = input.value;
                if(q.length < 1) { results.style.display = 'none'; return; }

                results.innerHTML = '<div style="padding:10px; color:#999;">Szukanie...</div>';
                results.style.display = 'block';

                try {
                    let items = [];
                    
                    if (type === 'Korepetytor') {
                        // Search Tutors
                        // Assuming we can search client-side or use API
                        const res = await fetch(`${API_BASE_URL}/api/admin/table/Korepetytorzy`);
                        const data = await res.json();
                        if (data.records) {
                            items = data.records
                                .map(r => ({ name: r.fields.ImieNazwisko, id: r.fields.ImieNazwisko })) // Use Name as ID for Tutor field
                                .filter(i => i.name && i.name.toLowerCase().includes(q.toLowerCase()));
                        }
                    } else {
                        // Search Clients
                        const res = await fetch(`${API_BASE_URL}/api/admin/search-clients?query=${encodeURIComponent(q)}`);
                        const data = await res.json();
                        if (data.clients) {
                            items = data.clients.map(c => ({ name: c.displayName, id: c.psid }));
                        }
                    }

                    if (items.length > 0) {
                        results.innerHTML = '';
                        items.forEach(item => {
                            const div = document.createElement('div');
                            div.style.padding = '10px';
                            div.style.cursor = 'pointer';
                            div.style.borderBottom = '1px solid #eee';
                            div.innerHTML = `<strong>${item.name}</strong>${item.id !== item.name ? `<br><small>${item.id}</small>` : ''}`;
                            div.onmouseover = () => div.style.backgroundColor = '#f0f2f5';
                            div.onmouseout = () => div.style.backgroundColor = 'white';
                            div.onclick = () => {
                                input.value = item.id; // Set Value
                                results.style.display = 'none';
                            };
                            results.appendChild(div);
                        });
                    } else {
                        results.innerHTML = '<div style="padding:10px; color:#999;">Brak wyników</div>';
                    }

                } catch (e) {
                    console.error(e);
                    results.innerHTML = '<div style="padding:10px; color:red;">Błąd</div>';
                }
            }, 300);
        }

        // Close autocomplete when clicking outside
        document.addEventListener('click', e => {
            if (!e.target.closest('[id^="autocomplete-"]') && !e.target.closest('input[oninput^="handleModalSearch"]')) {
                document.querySelectorAll('[id^="autocomplete-"]').forEach(el => el.style.display = 'none');
            }
        });

        // --- STATS PANEL ---
        async function loadStats() {
            const botStatusContainer = document.getElementById('botStatusCard');
            const dailySummaryContainer = document.getElementById('dailySummaryContainer');
            const errList = document.getElementById('errorLogsList');
            const scrList = document.getElementById('screenshotList');
            
            // Clear previous content to avoid stale data
            botStatusContainer.innerHTML = 'Ładowanie statusu...';
            dailySummaryContainer.innerHTML = '';
            errList.innerHTML = 'Ładowanie błędów...';
            scrList.innerHTML = 'Ładowanie zrzutów ekranu...';

            try {
                // 0. Comment Logs (for Log Komentarzy tab)
                const resL = await fetch(`${API_BASE_URL}/api/admin/comment-logs`);
                const dataL = await resL.json();
                const commentLogsContainer = document.getElementById('commentLogsContainer');

                if (dataL.logs && dataL.logs.length > 0) {
                    let commentLogsHtml = `<div class="table-responsive">
                        <table class="table-sm" style="min-width: auto;">
                            <thead><tr><th>Czas</th><th>Autor</th><th>Fragment posta</th><th>Scrolle</th><th>Status</th></tr></thead>
                            <tbody>
                                ${dataL.logs.map(log => `<tr>
                                    <td><small>${new Date(log.timestamp).toLocaleString()}</small></td>
                                    <td>${log.author}</td>
                                    <td>${log.post_snippet}...</td>
                                    <td style="text-align: right;">${log.scrolls_since_refresh}</td>
                                    <td>${log.status}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>`;
                    commentLogsContainer.innerHTML = commentLogsHtml;
                } else {
                    commentLogsContainer.innerHTML = '<p>Brak logów komentarzy.</p>';
                }

                // 1. Hourly Stats (for Działanie tab)
                const resH = await fetch(`${API_BASE_URL}/api/admin/facebook-hourly-stats`);
                const dataH = await resH.json();
                
                
                if(dataH.stats) {
                    const canvas = document.getElementById('hourlyStatsChart');
                    // Destroy previous chart instance if it exists
                    if (canvas.chart) {
                        canvas.chart.destroy();
                    }
                    canvas.chart = new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: dataH.stats.map(s => {
                                const d = new Date(s.timestamp);
                                return `${d.getHours()}:${(d.getMinutes()<10?'0':'')+d.getMinutes()}`;
                            }),
                            datasets: [{
                                label: 'Posty',
                                data: dataH.stats.map(s => s.loaded_posts_total),
                                backgroundColor: '#3699ff'
                            }, {
                                label: 'Komentarze',
                                data: dataH.stats.map(s => s.commented_posts),
                                backgroundColor: '#1bc5bd'
                            }]
                        },
                        options: { maintainAspectRatio: false, responsive: true }
                    });
                }

                // 2. Daily Summary & Bot Status (for Statystyki tab and main view)
                const resD = await fetch(`${API_BASE_URL}/api/admin/facebook-stats`);
                const dataD = await resD.json();
                
                // Bot Status Card (Always Visible)
                botStatusContainer.innerHTML = `
                 <div class="panel-card" style="border-left: 5px solid ${dataD.isRunning ? '#1bc5bd' : '#f64e60'};">
                    <div style="font-size:0.9rem; color:#7e8299;">Status Bota FB</div>
                    <div style="font-size:1.5rem; font-weight:700;">${dataD.isRunning ? 'AKTYWNY' : 'ZATRZYMANY'}</div>
                    <small>Ost. komentarz: ${dataD.lastCommentTime || '-'}</small>
                </div>
                `;
                
                // Daily Stats Table (Statystyki Tab)
                if(dataD.stats && dataD.stats.length > 0) {
                    dailySummaryContainer.innerHTML = `<div class="panel-card">
                        <h3 style="margin-top:0;">Podsumowanie dzienne</h3>
                        <div class="table-responsive">
                            <table class="table-sm" style="min-width: auto;">
                                <thead><tr><th>Data</th><th>Przesłane</th><th>Odrzucone</th><th>Oczekuje</th><th>Scrolle</th><th>Ost. Komentarz</th></tr></thead>
                                <tbody>
                                    ${dataD.stats.map(s => `<tr>
                                        <td>${s.Data}</td>
                                        <td>${s.Przeslane || 0}</td>
                                        <td>${s.Odrzucone || 0}</td>
                                        <td>${s.Oczekuje || 0}</td>
                                        <td>${s.Scrolls || 0}</td>
                                        <td>${s.LastCommentTime || '-'}</td>
                                    </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                } else {
                     dailySummaryContainer.innerHTML = '<div class="panel-card"><p>Brak statystyk dziennych.</p></div>';
                }

                // 3. Screenshots (for Działanie tab)
                const resS = await fetch(`${API_BASE_URL}/api/admin/facebook-status-screenshots`);
                const dataS = await resS.json();
                
                if(dataS.screenshots && dataS.screenshots.length > 0) {
                    let html = '<table class="table-sm" style="min-width: auto;">';
                    dataS.screenshots.forEach(s => {
                        html += `<tr><td><small>${s.timestamp}</small></td><td><a href="${API_BASE_URL}/api/admin/download-status-screenshot?file=${s.filename}" target="_blank">Pobierz</a></td></tr>`;
                    });
                    html += '</table>';
                    scrList.innerHTML = html;
                } else {
                    scrList.innerHTML = '<p>Brak zrzutów ekranu.</p>';
                }

                // 4. Errors (for Błędy tab)
                const resE = await fetch(`${API_BASE_URL}/api/admin/facebook-errors`);
                const dataE = await resE.json();
                
                if(dataE.errors && dataE.errors.length > 0) {
                    let html = '<table class="table-sm" style="min-width: auto;">';
                    dataE.errors.forEach(e => {
                        html += `<tr>
                            <td><small>${new Date(e.timestamp).toLocaleTimeString()}</small></td>
                            <td>${e.location}</td>
                            <td>${e.png ? `<a href="${API_BASE_URL}/api/admin/download-error?file=${e.png}" target="_blank">IMG</a>` : ''}</td>
                        </tr>`;
                    });
                    html += '</table>';
                    errList.innerHTML = html;
                } else {
                    errList.innerHTML = '<p>Brak błędów.</p>';
                }

            } catch(e) { 
                console.error(e); 
                botStatusContainer.innerHTML = '<div class="panel-card" style="color:red;">Błąd ładowania statystyk.</div>';
            }
        }

        // --- TUTORS VIEW ---
        async function loadTutorsView() {
            const container = document.getElementById('tutorsListContent');
            container.innerHTML = '<div style="padding:2rem; text-align:center; color:#999;"><i class="fas fa-spinner fa-spin fa-2x"></i><br><br>Ładowanie listy korepetytorów...</div>';
            
            try {
                // Reuse existing API for table data
                const res = await fetch(`${API_BASE_URL}/api/admin/table/Korepetytorzy`);
                const data = await res.json();

                if (!data.records || data.records.length === 0) {
                    container.innerHTML = '<div style="padding:2rem; text-align:center;">Brak korepetytorów.</div>';
                    return;
                }

                let html = '<div class="tutors-list-container">';
                
                data.records.forEach(rec => {
                    const f = rec.fields;
                    let subjects = Array.isArray(f.Przedmioty) ? f.Przedmioty.join(', ') : f.Przedmioty || '-';
                    const initials = (f.ImieNazwisko || '?').charAt(0).toUpperCase();
                    
                    html += `
                        <div class="tutor-card-item" onclick='openTutorManagement(${JSON.stringify(rec).replace(/'/g, "'")})'>
                            <div class="tutor-avatar">${initials}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 1.05rem; color: #181c32; margin-bottom: 3px;">${f.ImieNazwisko || 'Brak danych'}</div>
                                <div style="font-size: 0.9rem; color: #7e8299;">${subjects}</div>
                            </div>
                            <div>
                                <i class="fas fa-chevron-right" style="color: #b5b5c3;"></i>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;

            } catch(e) {
                container.innerHTML = `<div style="color:red; padding:1rem;">Błąd: ${e.message}</div>`;
            }
        }

        // --- TUTOR MANAGEMENT ---
        function openTutorManagement(record) {
            // Hide all views
            document.querySelectorAll('.panel-view').forEach(view => view.classList.add('hidden'));
            // Show details view
            document.getElementById('view-tutor-details').classList.remove('hidden');
            
            // Set header
            const tName = record.fields.ImieNazwisko || 'Nieznany';
            document.getElementById('tutorDetailsName').textContent = tName;
            document.getElementById('tutorDetailsId').textContent = `TutorID: ${record.fields.TutorID}`;
            
            state.currentTutorRecord = record; // Store for later use
            
            // Load stats
            loadTutorStats(tName);
        }

                        async function loadTutorStats(tutorName) {
            const container = document.getElementById('tutorManagementContent');
            container.innerHTML = '<div style="padding:2rem; text-align:center; color:#999;"><i class="fas fa-spinner fa-spin fa-2x"></i><br><br>Obliczanie statystyk...</div>';

            const calculateLessonPrice = (school_type, school_level, school_class) => {
                if (school_type === 'szkola_podstawowa') return 65;
                if (school_class && (String(school_class).toLowerCase().includes('4') || String(school_class).toLowerCase().includes('5'))) return 80;
                if (school_level === 'rozszerzony') return 75;
                return 70;
            };

            const getTutorRate = (school_type, school_class) => {
                if (school_type === 'szkola_podstawowa') return 35;
                if (school_type === 'liceum' || school_type === 'technikum') {
                    const cls = String(school_class || '');
                    if ((school_type === 'liceum' && cls.includes('4')) || (school_type === 'technikum' && cls.includes('5'))) return 45;
                    return 40;
                }
                return 0;
            };
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/admin/table/Rezerwacje`);
                const data = await res.json();
                
                if (!data.records) throw new Error('Brak danych rezerwacji');

                const lessons = data.records.filter(r => r.fields.Korepetytor === tutorName);
                
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const lastMonth = lastMonthDate.getMonth();
                const lastMonthYear = lastMonthDate.getFullYear();

                const dataTemplate = () => ({
                    primary: { hours: 0, tutor: 0, company: 0 },
                    highSchoolNormal: { hours: 0, tutor: 0, company: 0 },
                    highSchoolMatura: { hours: 0, tutor: 0, company: 0 },
                    total: { hours: 0, tutor: 0, company: 0 }
                });

                let thisMonthData = dataTemplate();
                let lastMonthData = dataTemplate();

                lessons.forEach(l => {
                    const f = l.fields;
                    if (!f.Data || f.Oplacona !== true) return;
                    
                    const status = f.Status || '';
                    if (status.includes('Anulowana') || status.includes('Odwołana') || status === 'Przeniesiona' || status === 'Dostępny' || status === 'Niedostępny' || status === 'Termin płatności minął') return;

                    const date = new Date(f.Data);
                    let targetData = null;

                    if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                        targetData = thisMonthData;
                    } else if (date.getMonth() === lastMonth && date.getFullYear() === lastMonthYear) {
                        targetData = lastMonthData;
                    }

                    if (targetData) {
                        const lessonPrice = calculateLessonPrice(f.TypSzkoly, f.Poziom, f.Klasa);
                        const tutorRate = getTutorRate(f.TypSzkoly, f.Klasa);
                        const companyProfit = lessonPrice - tutorRate;

                        let category = 'primary';
                        if (f.TypSzkoly === 'liceum' || f.TypSzkoly === 'technikum') {
                            const cls = String(f.Klasa || '');
                            category = ((f.TypSzkoly === 'liceum' && cls.includes('4')) || (f.TypSzkoly === 'technikum' && cls.includes('5'))) ? 'highSchoolMatura' : 'highSchoolNormal';
                        }
                        
                        targetData[category].hours++;
                        targetData[category].tutor += tutorRate;
                        targetData[category].company += companyProfit;
                    }
                });

                const calculateTotals = (dataObj) => {
                    dataObj.total.hours = dataObj.primary.hours + dataObj.highSchoolNormal.hours + dataObj.highSchoolMatura.hours;
                    dataObj.total.tutor = dataObj.primary.tutor + dataObj.highSchoolNormal.tutor + dataObj.highSchoolMatura.tutor;
                    dataObj.total.company = dataObj.primary.company + dataObj.highSchoolNormal.company + dataObj.highSchoolMatura.company;
                };
                calculateTotals(thisMonthData);
                calculateTotals(lastMonthData);
                
                const renderTable = (dataObj, monthName) => {
                    if (dataObj.total.hours === 0) return `<div class="panel-card" style="text-align:center; color: #999;">Brak opłaconych lekcji w ${monthName}.</div>`;
                    return `
                        <div class="table-responsive">
                            <table class="table" style="width: auto; min-width: 800px;">
                                <thead>
                                    <tr>
                                        <th>Poziom</th>
                                        <th style="text-align: right;">Ilość godzin</th>
                                        <th style="text-align: right;">Zarobek Korepetytora (Brutto)</th>
                                        <th style="text-align: right;">Przychód Firmy</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>Szkoła Podstawowa</td><td style="text-align: right;">${dataObj.primary.hours}</td><td style="text-align: right;">${dataObj.primary.tutor.toFixed(2)} zł</td><td style="text-align: right;">${dataObj.primary.company.toFixed(2)} zł</td></tr>
                                    <tr style="background-color: #f9f9fc;"><td>Szkoła Średnia (nie-maturalne)</td><td style="text-align: right;">${dataObj.highSchoolNormal.hours}</td><td style="text-align: right;">${dataObj.highSchoolNormal.tutor.toFixed(2)} zł</td><td style="text-align: right;">${dataObj.highSchoolNormal.company.toFixed(2)} zł</td></tr>
                                    <tr><td>Szkoła Średnia (maturalne)</td><td style="text-align: right;">${dataObj.highSchoolMatura.hours}</td><td style="text-align: right;">${dataObj.highSchoolMatura.tutor.toFixed(2)} zł</td><td style="text-align: right;">${dataObj.highSchoolMatura.company.toFixed(2)} zł</td></tr>
                                </tbody>
                                <tfoot>
                                    <tr style="font-weight: bold; border-top: 2px solid #333;"><td>Suma</td><td style="text-align: right;">${dataObj.total.hours}</td><td style="text-align: right;">${dataObj.total.tutor.toFixed(2)} zł</td><td style="text-align: right;">${dataObj.total.company.toFixed(2)} zł</td></tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                };

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="panel-card" style="background: #e1f0ff; border-color: #b5d0f5; text-align: center; cursor: pointer;" onclick="showTutorStatsDetails('this-month')">
                            <div style="font-size: 0.9rem; color: #0050a5; margin-bottom: 5px;">Lekcje w tym miesiącu</div>
                            <div style="font-size: 2.5rem; font-weight: 800; color: #0050a5;">${thisMonthData.total.hours}</div>
                        </div>
                        <div class="panel-card" style="background: #fff4de; border-color: #ffe2b5; text-align: center; cursor: pointer;" onclick="showTutorStatsDetails('last-month')">
                            <div style="font-size: 0.9rem; color: #b58105; margin-bottom: 5px;">Lekcje w zeszłym miesiącu</div>
                            <div style="font-size: 2.5rem; font-weight: 800; color: #b58105;">${lastMonthData.total.hours}</div>
                        </div>
                    </div>

                    <div id="tutor-stats-details-this-month" class="tutor-stats-details-container" style="display: none;">
                        <h3 style="margin-bottom: 1rem;">Rozliczenie (Bieżący Miesiąc)</h3>
                        ${renderTable(thisMonthData, 'bieżącym miesiącu')}
                    </div>
                    <div id="tutor-stats-details-last-month" class="tutor-stats-details-container" style="display: none;">
                        <h3 style="margin-bottom: 1rem;">Rozliczenie (Zeszły Miesiąc)</h3>
                        ${renderTable(lastMonthData, 'zeszłym miesiącu')}
                    </div>
                `;

            } catch(e) {
                console.error(e);
                container.innerHTML = `<div style="color:red; padding:1rem; text-align:center;">Błąd ładowania statystyk: ${e.message}</div>`;
            }
        }

        function showTutorStatsDetails(month) {
            document.querySelectorAll('.tutor-stats-details-container').forEach(el => el.style.display = 'none');
            const details = document.getElementById(`tutor-stats-details-${month}`);
            if (details) {
                details.style.display = 'block';
            }
        }

        function backToTutorsList() {
             document.querySelectorAll('.panel-view').forEach(view => view.classList.add('hidden'));
             document.getElementById('view-tutors').classList.remove('hidden');
        }

        // --- UTILS ---
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    </script>
</body>
</html>